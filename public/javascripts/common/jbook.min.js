/**
 * Created by JoeLiu on 2018-2-2.
 */
var Common={subscrib:function(ev,callback){this._callbacks||(this._callbacks={});(this._callbacks[ev]||(this._callbacks[ev]=[])).push(callback);return this},publish:function(){var args=Array.prototype.slice.call(arguments);var ev=args.shift();if(!this._callbacks)return this;if(!this._callbacks[ev])return this;for(var i=0;i<this._callbacks[ev].length;i++){this._callbacks[ev][i].apply(this,args)}return this}};var JBook=(function(){let _this=this;function pageElementEventHandler(e){var target=e.target||e.srcElemnt;var fullPropName=target.getAttribute('j-book');if(fullPropName&&fullPropName!==''){Common.publish('ui-update-event',fullPropName,target.value)}};if(document.addEventListener){document.addEventListener('keyup',pageElementEventHandler,false);document.addEventListener('change',pageElementEventHandler,false)}else{document.attachEvent('onkeyup',pageElementEventHandler);document.attachEvent('onchange',pageElementEventHandler)};function refreshdom(dom,sfullname,spropvalue){let unbind=dom.getAttribute('j-bind');if(unbind!==null){var elementType=dom.tagName.toLowerCase();if(elementType==='input'||elementType==='textarea'||elementType==='select'){dom.value=spropvalue}else{dom.innerHTML=spropvalue}}let unstyle=dom.getAttribute('j-style');var regs=new RegExp("\{\{.+\}\}",'i');var execstr=regs.exec(unstyle,'i');if(execstr){execstr=execstr[0].replace(/\{|\}/g,'');var exeresult=eval(execstr);dom.setAttribute('style',unstyle.replace(/\{\{.+\}\}/g,exeresult))}let unclass=dom.getAttribute('j-class');var execclass=regs.exec(unclass,'i');if(execclass){execclass=execclass[0].replace(/\{|\}/g,'');var exeresultc=eval(execclass);dom.setAttribute('class',unclass.replace(/\{\{.+\}\}/g,exeresultc))}return dom};function refreshArray(dom,sfullname,spropvalue){let valType=typeof spropvalue;if(valType=='object'){for(val in spropvalue){let arrnames=sfullname+'.'+val;var attr=dom.getAttribute('j-foritem');if(attr==arrnames){refreshdom(dom,arrnames,spropvalue[val])}}}if(valType=='number'||valType=='string'){var attr=dom.getAttribute('j-foritem');if(attr==sfullname){refreshdom(dom,sfullname,spropvalue)}}let elelisttm=dom.children;let elelist=[];for(var j=0,lenj=elelisttm.length;j<lenj;j++){elelist.push(elelisttm[j])}if(elelist.length>0){dom.innerHTML="";elelist.forEach(em=>{let newem=refreshArray(em.cloneNode(true),sfullname,spropvalue);dom.appendChild(newem)})}return dom};Common.subscrib('model-update-event',function(fullPropName,propValue){var elements=document.querySelectorAll('[j-book="'+fullPropName+'"]');for(var i=0,len=elements.length;i<len;i++){let unfor=elements[i].getAttribute('j-for');if(unfor){unforlist=unfor.split(' ');let ele=elements[i].children[0];elements[i].innerHTML='';propValue.forEach(m=>{_this[unforlist[0]]=m;let newem=refreshArray(ele.cloneNode(true),unforlist[0],m);elements[i].appendChild(newem)})}else{refreshdom(elements[i],fullPropName,propValue)}}});return{'modelName':'','create':function(modelName){var self=this;self.modelName=modelName;Common.subscrib('ui-update-event',function(fullPropName,propValue){var propPathArr=fullPropName.split('.');self.setData(propPathArr[1],propValue)});return Object.create(this)},'init':function(modelData){for(prop in modelData){this.setData(prop,modelData[prop])}},'setData':function(propName,propValue){eval(this.modelName)[propName]=propValue;Common.publish('model-update-event',this.modelName+'.'+propName,propValue)}}})();